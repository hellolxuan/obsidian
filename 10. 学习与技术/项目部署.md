[toc]

# 项目部署

# 1. Docker 安装

一切命令皆参考[官方安装文档](https://docs.docker.com/engine/install/)

## 1.1 CentOS：

### 1.1.1 卸载旧版本 docker

```CentOS
# 
yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
#                   

# 

# 

# 

# 

# 

# （

```

### 1.1.2 安装必要工具

```CentOS
yum install -y yum-utils device-mapper-persistent-data lvm2
```

### 1.1.3 设置 yum 源

```CentOS
yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
```

### 1.1.4 下载 docker

```CentOS
yum install -y docker-ce
```

## 1.2 Ubuntu：

### 1.2.1 操作系统要求

要安装 Docker 引擎，您需要以下 Ubuntu 版本之一的 64 位版本：

- Ubuntu Jammy 22.04 （LTS）
- Ubuntu Impish 21.10
- Ubuntu Focal 20.04 （LTS）
- Ubuntu Bionic 18.04 （LTS）

Docker `x86_64` `amd64` `armhf` `arm64` `s390x` 支持这些体系结构。

### 1.2.2 卸载旧版本

```Ubuntu
sudo apt-get remove docker docker-engine docker.io containerd runc
```

### 1.2.3 设置存储库

1. 更新软件包索引并安装软件包，以允许通过 HTTPS 使用存储库：`apt`

   ```Ubuntu
   sudo apt-get update
   ```

   ```Ubuntu
   sudo apt-get install \
       ca-certificates \
       curl \
       gnupg \
       lsb-release
   ```

2. 添加 Docker 的官方 GPG 密钥：

   ```Ubuntu
   sudo mkdir -p /etc/apt/keyrings
   ```
   
   ```Ubuntu
   curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
   ```

### 1.2.4 安装 Docker

1. 更新包索引，并安装*最新版本*的 Docker 引擎、容器和 Docker Compose

   ```Ubuntu
   sudo apt-get update
   ```

   ```Ubuntu
   sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
   ```

2. 列出可用版本的 Docker 

   ```Ubuntu
   apt-cache madison docker-ce
   ```

3. 选择并安装，如。`5:20.10.16~3-0~ubuntu-jammy` 替换下面的`<VERSION_STRING>`

   ```Ubuntu
   sudo apt-get install docker-ce=<VERSION_STRING> docker-ce-cli=<VERSION_STRING> containerd.io docker-compose-plugin
   ```

## 1.3 启动 docker

启动docker

```linux
systemctl start docker
```

开机自启动

```linux
systemctl enable docker
```

重启docker

```linux
systemctl restart docker
```

进入容器

```linux
docker exec -it 【容器名或者id】 /bin/bash 
```

# 2. 安装 MySQL

## 2.1 下载 MySQL 镜像

```linux
docker pull mysql
```

## 2.2 启动 MySQL 容器

```linux
docker run --name mysql --restart=always -p 3306:3306 -e MYSQL_ROOT_PASSWORD=密码 -d mysql
```

**以下是可选命令**

```linux
mysql -u root -p //连接数据库
show databases; //查看数据库
create database 【数据库名】; //创建数据库
use 【数据库名】 //使用该数据库

# 拷贝SQL文件到mysql容器中
docker cp yyy.sql mysql:/yyy.sql据库
# 登陆控制台执行source 命令
mysql> source yyy.sql
```



# 3. 安装 Redis

## 3.1 下载 Redis 镜像

```linux
docker pull redis
```
## 3.2 启动 Redis 容器

```linux
docker run --name redis  --restart=always -p 6379:6379 -d redis --requirepass "lx*0+" 
```

# 4. 安装 RabbitMQ

## 4.1 下载 RabbitMQ 镜像

```linux
docker pull rabbitmq:management
```
## 4.2 启动 RabbitMQ ，默认guest用户，密码也是guest。

```linux
docker run --name rabbit --restart=always -p 15672:15672 -p 5672:5672  -d  rabbitmq:management   
```

# 5. 后端

## 5.1 将后端文件传入 /usr/local/docker 下

##  5.2 编写 Dockerfile 文件

在/usr/local/docker/Dockerfile文件中写入以下内容

```dockerfile
FROM java:8
VOLUME /tmp
ADD blog-springboot-0.0.1.jar blog.jar       
ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","/blog.jar"] 
```

**ps：Dockerfile文件不需要后缀，直接为文件格式**

## 5.3 制作后端镜像

```dockerfile
docker build -t blog .
```

## 5.4 启动后端镜像

```dockerfile
docker run --name blog --restart=always -p 8080:8080 -d blog
```

#  6. 前端

## 6.1 将前端文件传入 /usr/local/docker 下

## 6.2 安装 nginx

```
docker pull nginx //下载nginx镜像
```

## 6.3 nginx.conf

在/usr/local/nginx下创建nginx.conf文件，格式如下

### 6.3.1 这是不需要域名的

```nginx
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    client_max_body_size     50m;
    client_body_buffer_size  10m; 
    client_header_timeout    1m;
    client_body_timeout      1m;

    gzip on;
    gzip_min_length  1k;
    gzip_buffers     4 16k;
    gzip_comp_level  4;
    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;
    gzip_vary on;

server {
        listen       80;
        server_name  150.230.40.181;
     
        location / {		
            root   /usr/local/docker/blog;
            index  index.html index.htm; 
            try_files $uri $uri/ /index.html;	
        }
			
	location ^~ /api/ {		
            proxy_pass http://150.230.40.181:8080/;
	    proxy_set_header   Host             $host;
            proxy_set_header   X-Real-IP        $remote_addr;						
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        }
		
    }
	
server {
        listen       81;
        server_name  150.230.40.181;
     
        location / {		
            root   /usr/local/docker/admin;
            index  index.html index.htm; 
            try_files $uri $uri/ /index.html;	
        }
			
	location ^~ /api/ {		
            proxy_pass http://150.230.40.181:8080/;
	    proxy_set_header   Host             $host;
            proxy_set_header   X-Real-IP        $remote_addr;						
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        }
		
    }

server {
        listen       82;
        server_name  150.230.40.181;
     
        location / {
          proxy_pass http://150.230.40.181:8080/websocket;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "Upgrade";
          proxy_set_header Host $host:$server_port;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
       }
	
    }

server {
        listen       83;
        server_name  150.230.40.181;

        location / {		
           root /usr/local/docker/upload/;
        }		
		
    }
 
}


```
### 6.3.2 这是有域名的

```
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    client_max_body_size     50m;
    client_body_buffer_size  10m; 
    client_header_timeout    1m;
    client_body_timeout      1m;

    gzip on;
    gzip_min_length  1k;
    gzip_buffers     4 16k;
    gzip_comp_level  4;
    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;
    gzip_vary on;

server {
        listen       80;
        server_name  www.lxuan.fun;
     
        location / {		
            root   /usr/local/docker/blog;
            index  index.html index.htm; 
            try_files $uri $uri/ /index.html;	
        }
			
	location ^~ /api/ {		
            proxy_pass http://150.230.40.181:8080/;
	    proxy_set_header   Host             $host;
            proxy_set_header   X-Real-IP        $remote_addr;						
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        }
		
    }
	
server {
        listen       80;
        server_name  admin.lxuan.fun;
     
        location / {		
            root   /usr/local/docker/admin;
            index  index.html index.htm; 
            try_files $uri $uri/ /index.html;	
        }
			
	location ^~ /api/ {		
            proxy_pass http://150.230.40.181:8080/;
	    proxy_set_header   Host             $host;
            proxy_set_header   X-Real-IP        $remote_addr;						
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        }
		
    }

server {
        listen       80;
        server_name  www.ws.lxuan.fun;
     
        location / {
          proxy_pass http://150.230.40.181:8080/websocket;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "Upgrade";
          proxy_set_header Host $host:$server_port;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
       }
	
    }

server {
        listen       80;
        server_name  www.static.lxuan.fun;

        location / {		
           root /usr/local/docker/upload/;
        }		
		
    }
 
}


```

## 6.4启动 nginx

### 6.4.1 不需要域名的：

```dockerfile
docker run --name nginx --restart=always -p 80:80 -p 81:81 -p 82:82 -p 83:83 -d -v /usr/local/nginx/nginx.conf:/etc/nginx/nginx.conf -v /usr/local/docker:/usr/local/docker -v /usr/local/docker/upload:/usr/local/docker/upload nginx
```
### 6.4.2 需要域名的：

```dockerfile
docker run --name nginx --restart=always -p 80:80 -d -v /usr/local/nginx/nginx.conf:/etc/nginx/nginx.conf -v /usr/local/docker:/usr/local/docker -v /usr/local/upload:/usr/local/upload nginx 
```